# 07. ReplicaSet

Replication Controllerì™€ ReplicaSet ëª¨ë‘ ì‹¤í–‰ ì¤‘ì¸ pod ëª©ë¡ì„ ì§€ì†ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” pod ë“¤ì˜ ì‹¤ì œ ìˆ˜ê°€ ì˜ë„í•˜ëŠ” ìˆ˜ì™€ ë™ì¼í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë¦¬ì†ŒìŠ¤ì´ë‹¤.

í•˜ì§€ë§Œ Replication ControllerëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ì¶”ì„¸ì´ë©°, ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ë§Œ ì¢€ë” ë‚˜ì€ ReplicaSetì„ ê±°ì˜ ì‚¬ìš©í•œë‹¤.

4.3.1 Replication Controllerì™€ ReplicaSet ë¹„êµ

ë‘ ë¦¬ì†ŒìŠ¤ëŠ” ë™ì¼í•˜ê²Œ ë„ì‘í•˜ì§€ë§Œ ReplicaSetì„ ì´ìš”í•˜ë©´ ì¢€ ë” ì •êµí•œ pod selectorë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

Replication Controller : íŠ¹ì • ë ˆì´ë¸”ì´ ìˆëŠ” podë§Œ í•„í„°ë§

ReplicaSet : íŠ¹ì • ë ˆì´ë¸”ì´ ì—†ê±°ë‚˜ ë ˆì´ë¸”ì˜ ê°’ê³¼ ìƒê´€ì—†ì´ íŠ¹ì • ë ˆì´ë¸”ì˜ keyë¥¼ ê°–ëŠ” pod í•„í„°ë§ ê°€ëŠ¥

ReplicationControllerëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ReplicaSetì— ì¢€ ë” ì§‘ì¤‘í•´ì„œ ì•Œì•„ë³´ê¸°ë¡œ í•œë‹¤.

4.3.2 ReplicaSet ë™ì‘ ì›ë¦¬

<figure><img src="https://blog.kakaocdn.net/dn/cjaqMF/btq1MrC1m7h/UEBoY0btxNEyJQamd2TkNK/img.png" alt=""><figcaption></figcaption></figure>

* ê¸°ì¡´ podê°€ ì‚¬ë¼ì§€ë©´ ìƒˆ podë¥¼ ì‹œì‘í•´ ì˜ë„í•˜ëŠ” ìˆ˜ì˜ podë¥¼ ìœ ì§€í•œë‹¤.
* í´ëŸ¬ìŠ¤í„° ë…¸ë“œì— ì¥ì• ê°€ ë°œìƒí•˜ë©´ ReplicaSetìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” podë“¤ì— ëŒ€í•œ ë³µì œë³¸ ìƒì„±
* ìˆ˜ë™, ìë™ìœ¼ë¡œ pod ìˆ˜í‰ í™•ì¥ì´ ê°„í¸í•´ì§

4.3.2 ReplicaSet ìƒì„±í•˜ê¸°

```
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: kubia
spec:
  replicas: 3
  selector:
    matchLabels:
      app: kubia
  template:
    metadata:
      labels:
        app: kubia
    spec:
      containers:
      - name: kubia
        image: luksa/kubia
```

* match Selector : replicasetìœ¼ë¡œ ê´€ë¦¬í•  podë¥¼ ì§€ì •í•œë‹¤. ì—¬ê¸°ì— ëª…ì‹œëœ label ì„ ê°€ì§„ podë¥¼ ëŒ€ìƒìœ¼ë¡œ ì—¬ê¸°ê²Œ ëœë‹¤.
* replicas : ì‹¤í–‰í•  íŒŒë“œì˜ ì˜ë„í•˜ëŠ”(desired) ìˆ˜ë¥¼ ì§€ì •í•œë‹¤.
* pod template : ìƒˆë¡œìš´ pod replicaë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©í•œë‹¤. ëŒ€ìƒì´ ë˜ëŠ” podì— ëŒ€í•œ ëª…ì„¸ì´ë‹¤

&#x20;  ğŸ”¹ MatchExpressions ì‚¬ìš©í•˜ì—¬ ì…€ë ‰í„°ì— í‘œí˜„ì‹ ì‚¬ìš©í•˜ê¸°

```
apiVersion: apps/v1beta2
kind: ReplicaSet
metadata:
  name: kubia
spec:
  replicas: 3
  selector:
    matchExpressions:
      - key: app
        operator: In
        values:
         - kubia
  template:
    metadata:
      labels:
        app: kubia
    spec:
      containers:
      - name: kubia
        image: luksa/kubia
```

* In : ë ˆì´ë¸” ê°’ì´ ì§€ì •ëœ ê°’ ì¤‘ í•˜ë‚˜ì™€ ì¼ì¹˜
* NotIn : ë ˆì´ë¸” ê°’ì´ ì§€ì •ëœ ê°’ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ
* Exists : ì§€ì •ëœ keyë¥¼ ê°€ì§„ labelì„ í¬í•¨í•˜ëŠ” pod
* DoesNotExist: Podì— ì§€ì •ëœ keyë¥¼ ê°€ì§„ labelì´ í¬í•¨ë˜ì§€ ì•Šì•„ì•¼ í•¨

4.3.3 ReplicaSet ìƒì„± ë° í™•ì¸

```
root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get rs
NAME    DESIRED   CURRENT   READY   AGE
kubia   3         3         3       9s


root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
kubia-8qdbg   1/1     Running   0          77s
kubia-qd5nf   1/1     Running   0          77s
kubia-sqlbh   1/1     Running   0          77s
```

replica 3ìœ¼ë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— kubiaë¼ëŠ” podì— ëŒ€í•´ ë³µì œë³¸ 3ê°œê°€ ìƒì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

ì´ì œ ê³ ì˜ë¡œ í•˜ë‚˜ì˜ podë¥¼ ì‚­ì œí•œë‹¤.

ì‚­ì œëœ podê°€ terminating ìƒíƒœì— ë„ì…ë¨ê³¼ ë™ì‹œì— ìƒˆë¡œìš´ podê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•œë‹¤.

```
root@master001:~# kubectl delete pod kubia-8qdbg
pod "kubia-8qdbg" deleted

root@master001:~# kubectl get pods
NAME          READY   STATUS        RESTARTS   AGE
kubia-8qdbg   1/1     Terminating   0          41m
kubia-qd5nf   1/1     Running       0          41m
kubia-sqlbh   1/1     Running       0          41m
kubia-tlxg6   1/1     Running       0          20s

root@master001:~# kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
kubia-qd5nf   1/1     Running   0          43m
kubia-sqlbh   1/1     Running   0          43m
kubia-tlxg6   1/1     Running   0          2m1s
```

4.3.4 ReplicaSetì˜ ì„¸ë¶€ ì •ë³´ í™•ì¸í•˜ê¸°

```
root@master001:~# kubectl describe rs kubia
Name:         kubia
Namespace:    default
Selector:     app=kubia
Labels:       <none>
Annotations:  <none>
Replicas:     3 current / 3 desired
Pods Status:  3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:  app=kubia
  Containers:
   kubia:
    Image:        luksa/kubia
    Port:         <none>
    Host Port:    <none>
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Events:
  Type    Reason            Age    From                   Message
  ----    ------            ----   ----                   -------
  Normal  SuccessfulCreate  46m    replicaset-controller  Created pod: kubia-qd5nf
  Normal  SuccessfulCreate  46m    replicaset-controller  Created pod: kubia-8qdbg
  Normal  SuccessfulCreate  46m    replicaset-controller  Created pod: kubia-sqlbh
  Normal  SuccessfulCreate  4m50s  replicaset-controller  Created pod: kubia-tlxg6
```

* Replicas/current : í˜„ì¬ ë™ì‘í•˜ëŠ” pod ìˆ˜
* Replicas/desired : ìœ ì§€í•˜ê³ ì í•˜ëŠ” pod ìˆ˜
* Pods Status : Podì˜ ìƒíƒœë³„ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜
* Events : ReplicaSetê³¼ ê´€ë ¨ëœ ì´ë²¤íŠ¸

4.3.5 ìˆ˜í‰ pod ìŠ¤ì¼€ì¼ë§

kubectl ëª…ë ¹ì–´ë¡œ scale up/down

```
root@master001:~# kubectl scale rs kubia --replicas=10
replicaset.apps/kubia scaled
```

kubectl editìœ¼ë¡œ ì˜¤ë¸Œì íŠ¸ ì •ì˜ ìˆ˜ì •

```
root@master001:~# kubectl get rs
NAME    DESIRED   CURRENT   READY   AGE
kubia   10        10        10      98m

root@master001:~# kubectl edit rs kubia
spec:
  replicas: 2
  selector:
    matchLabels:
      app: kubia
      ..
replicaset.apps/kubia edited

root@master001:~# kubectl get rs
NAME    DESIRED   CURRENT   READY   AGE
kubia   2         2         2       99m
```

4.3.6 pod ìœ ì§€í•˜ë©° replicaset ì‚­ì œí•˜ê¸°

kubectl delete ëª…ë ¹ì— ì˜µì…˜ì—†ì´ ì‚¬ìš©í•˜ë©´ ReplicaSetê³¼ ì—°ê´€ ë˜ì–´ ê´€ë¦¬ë˜ëŠ” pod ê¹Œì§€ ëª¨ë‘ ì‚­ì œëœë‹¤.

ì´ë•Œ cacscade ì˜µì…˜ìœ¼ë¡œ pod ëŠ” ìœ ì§€í•  ìˆ˜ ìˆë‹¤.

```
root@master001:~# kubectl delete rs kubia --cascade=false
warning: --cascade=false is deprecated (boolean value) and can be replaced with --cascade=orphan.
replicaset.apps "kubia" deleted

root@master001:~# kubectl get rs
No resources found in default namespace.

root@master001:~# kubectl get po
NAME          READY   STATUS    RESTARTS   AGE
kubia-qd5nf   1/1     Running   0          108m
kubia-sqlbh   1/1     Running   0          108m
```
