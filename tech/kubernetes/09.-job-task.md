# 09. Jobìœ¼ë¡œ ì™„ë£Œ ê°€ëŠ¥í•œ ë‹¨ì¼ task êµ¬í˜„í•˜ê¸°

Pod, ReplicaSet, DaemonSet ë“±ìœ¼ë¡œ ìƒì„±í•œ í”„ë¡œì„¸ìŠ¤ëŠ” ì§€ì†ì ìœ¼ë¡œ ë™ì‘ë˜ë©°, ë³„ë„ì˜ ì™„ë£Œ ì‹œì ì´ ì—†ë‹¤.

ë°˜ë©´ ì™„ë£Œëœ í›„ ë‹¤ì‹œ ì‹œì‘ë˜ì§€ ì•ŠëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ Job ë¦¬ì†ŒìŠ¤ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

4.5.1 Job ì†Œê°œ

Jobì€ ì‘ì—…ì´ ì œëŒ€ë¡œ ì™„ë£Œë˜ì–´ì•¼ í•˜ëŠ” ì„ì‹œ ì‘ì—…ì— ìœ ìš©í•˜ê²Œ ì“°ì¸ë‹¤.

Jobìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” podëŠ” í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ê¸° ì „ê¹Œì§€ëŠ” ë™ì‘í•˜ë„ë¡ ìš´ì˜ëœë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ í•˜ë‚˜ì˜ nodeì— ì¥ì• ê°€ ìƒê²¼ì„ë•Œ ê·¸ ìœ„ì—ì„œ ë™ì‘í•˜ë˜ Jobìœ¼ë¡œ ìƒì„±í•œ podëŠ” ë‹¤ë¥¸ nodeì— ìë™ ìŠ¤ì¼€ì¤„ë§ ëœë‹¤.

4.5.2 Job Resource

Job ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•œë‹¤.

ì•„ë˜ yaml ì •ì˜ì—ì„œ ì‚¬ìš©í•œ imageëŠ” 120ì´ˆ ë™ì•ˆ ì‹¤í–‰í•œ í›„ ì¢…ë£Œëœë‹¤.

```
apiVersion: batch/v1
kind: Job
metadata:
  name: batch-job
spec:
  template:
    metadata:
      labels:
        app: batch-job
    spec:
      restartPolicy: OnFailure
      containers:
      - name: main
        image: luksa/batch-job
```

* apiVersion: Jobì€ batch API ê·¸ë£¹ì— ì†í•˜ë©°, v1ì— í•´ë‹¹í•œë‹¤.
* spec: ì»¨í…Œì´ë„ˆì˜ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë  ë•Œ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ìˆ˜í–‰í•  ì‘ì—…ì„ ì§€ì •í•œë‹¤.
* spec/restartPolicy: Jobì€ ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì‹œì‘(Always) ì •ì±…ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. podì˜ ë™ì‘ì´ ì‹¤íŒ¨í–ˆì„ ê²½ìš° restart í•˜ë„ë¡ í•œë‹¤. (OnFailure/Never ë¥¼ valueë¡œ ì‚¬ìš©í•œë‹¤)

```
root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl create -f batch-job.yaml
job.batch/batch-job created

root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get po
NAME                READY   STATUS    RESTARTS   AGE
batch-job-b5sdv     1/1     Running   0          6s
```

```
root@master001:~# kubectl get jobs
NAME        COMPLETIONS   DURATION   AGE
batch-job   1/1           2m5s       19m
```

í•´ë‹¹ podì˜ ë¡œê·¸ë¥¼ ë³´ë©´ 120ì´ˆ í›„ ì¢…ë£Œë˜ì—ˆìŒì„ ë³¼ ìˆ˜ ìˆë‹¤.

```
root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04/batch-job# kubectl logs batch-job-b5sdv
Mon Apr  5 08:45:59 UTC 2021 Batch job starting
Mon Apr  5 08:47:59 UTC 2021 Finished succesfully
```

4.5.3 Jobì—ì„œ ì—¬ëŸ¬ Pod ì¸ìŠ¤í„´ìŠ¤ ì‹¤í–‰í•˜ê¸°

jobì„ ì‚¬ìš©í•˜ì—¬ ë‘ ê°œ ì´ìƒì˜ pod ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ ë³‘ë ¬ í˜¹ì€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.

jobì˜ specì— completionsì™€ parallelism ì†ì„±ì„ ì„¤ì •í•œë‹¤.

&#x20;   ğŸ”¹ ìˆœì°¨ì ìœ¼ë¡œ Pod ì‹¤í–‰í•˜ê¸°

&#x20;    completions : jobì˜ podë¥¼ ëª‡ ë²ˆ ì‹¤í–‰í• ì§€ ì„¤ì •í•œë‹¤.

&#x20;    ì´ ê²½ìš° completionsì„ 5ë¡œ ì„¤ì •í•˜ì˜€ë‹¤.

&#x20;    ì™„ë£Œëœ pod í›„ì— ìƒˆë¡œìš´ podë¥¼ ìƒì„±í•˜ì—¬ ê²°ê³¼ì ìœ¼ë¡œëŠ” ì—°ì†ì ìœ¼ë¡œ 5ê°œì˜ podë¥¼ ì‹¤í–‰í•˜ë„ë¡ í•œë‹¤.

```
apiVersion: batch/v1
kind: Job
metadata:
  name: multi-completion-batch-job
spec:
  completions: 5
  template:
    metadata:
      labels:
        app: batch-job
    spec:
      restartPolicy: OnFailure
      containers:
      - name: main
        image: luksa/batch-job
```

ë˜í•œ í•´ë‹¹ jobì´ ëë‚˜ë©´ podëŠ” completed ìƒíƒœê°€ ëœë‹¤.

```
root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get po
NAME                READY   STATUS      RESTARTS   AGE
batch-job-b5sdv     0/1     Completed   0          53m
```

&#x20;   ğŸ”¹ ë³‘ë ¬ë¡œ Pod ì‹¤í–‰í•˜ê¸°

&#x20;    parallelism : ì—¬ëŸ¬ jobì´ ë³‘ë ¬ë¡œ ì‹¤í–‰ë˜ë„ë¡ í•œë‹¤.

&#x20;    completionì„ 5ë¡œ í•˜ì—¬ ì´ 5ê°œì˜ podë¥¼ ì™„ë£Œí•˜ë„ë¡ ì„¤ì •í–ˆìœ¼ë©°,

&#x20;    í•œë²ˆì— ë‘ ê°œê¹Œì§€ ë³‘ë ¬ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

```
apiVersion: batch/v1
kind: Job
metadata:
  name: multi-completion-batch-job
spec:
  completions: 5
  parallelism: 2
  template:
    metadata:
      labels:
        app: batch-job
    spec:
      restartPolicy: OnFailure
      containers:
      - name: main
        image: luksa/batch-job
```

ì‹¤í–‰ì‹œí‚¤ë©´ ì´ì™€ ê°™ì´ ë‘ê°œì˜ podê°€ ë³‘ë ¬ë¡œ ì‹¤í–‰ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ë‘ ê°œì˜ podê°€ ì™„ë£Œëœ í›„ì—ëŠ” ë‹¤ì‹œ 2ê°œì˜ podê°€ ìƒì„±ëœë‹¤.

```
root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
multi-completion-batch-job-nlhvs   1/1     Running   0          100s
multi-completion-batch-job-slr7h   1/1     Running   0          100s

root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get po
NAME                               READY   STATUS      RESTARTS   AGE
multi-completion-batch-job-4r5kx   1/1     Running     0          52s
multi-completion-batch-job-nlhvs   0/1     Completed   0          2m55s
multi-completion-batch-job-slr7h   0/1     Completed   0          2m55s
multi-completion-batch-job-w6qzg   1/1     Running     0          49s

root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get po
NAME                               READY   STATUS      RESTARTS   AGE
multi-completion-batch-job-4r5kx   0/1     Completed   0          12m
multi-completion-batch-job-kdprb   0/1     Completed   0          10m
multi-completion-batch-job-nlhvs   0/1     Completed   0          14m
multi-completion-batch-job-slr7h   0/1     Completed   0          14m
multi-completion-batch-job-w6qzg   0/1     Completed   0          12m
```

4.5.5 ì¡ podê°€ ì™„ë£Œë˜ëŠ” ë° ê±¸ë¦¬ëŠ” ì‹œê°„ ì œí•œí•˜ê¸°

Jobì´ íŠ¹ì • ìƒíƒœì— ë¹ ì ¸ ì™„ë£Œí•  ìˆ˜ ì—†ëŠ”ê²½ìš° activeDeadlineSeconds ì†ì„±ìœ¼ë¡œ podì˜ ì‹¤í–‰ ì‹œê°„ì„ ì œí•œí•  ìˆ˜ ìˆë‹¤.

Podê°€ ì´ë³´ë‹¤ ì˜¤ë˜ ì‹¤í–‰ë˜ë©´ ì‹œìŠ¤í…œì´ ì¢…ë£Œë¥¼ ì‹œë„í•˜ê³ , í•´ë‹¹ jobì€ ì‹¤íŒ¨ë¡œ ë‚¨ëŠ”ë‹¤.

4.6 Jobì„ ì£¼ê¸°ì ìœ¼ë¡œ ë˜ëŠ” í•œ ë²ˆ ì‹¤í–‰ë˜ë„ë¡ ìŠ¤ì¼€ì¤„ë§ í•˜ê¸°

ë¦¬ëˆ…ìŠ¤ì—ì„œì˜ cron ì‘ì—…ì„ kubernetesì—ì„œë„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

yaml íŒŒì¼ì—ì„œ cronjobì–‘ì‹ì„ ë§Œë“¤ì–´ì„œ êµ¬ì„±í•œë‹¤.

4.6.1 í¬ë¡ ì¡ ìƒì„±í•˜ê¸°

```
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: batch-job-every-fifteen-minutes
spec:
  schedule: "0,15,30,45 * * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: periodic-batch-job
        spec:
          restartPolicy: OnFailure
          containers:
          - name: main
            image: luksa/batch-job
```

ìŠ¤ì¼€ì¤„ì„¤ì •í•˜ê¸°

&#x20; crontabì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ê³¼ ë™ì¼í•˜ë‹¤.

&#x20; ë¶„ ì‹œ ì¼ ì›” ìš”ì¼ ìˆœìœ¼ë¡œ ë‚˜ì—´í•˜ë©°, \*ë¡œ ê¸°ì…ë  ê²½ìš° ë§¤ ë‹¨ìœ„ë§ˆë‹¤ ë™ì‘ì‹œí‚´ì„ ì˜ë¯¸í•œë‹¤.

ìœ„ì˜ yamlíŒŒì¼ë¡œ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•œë’¤ ë‹¤ìŒê³¼ ê°™ì´ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

```
root@master001:~/k8s_in_action/kubernetes-in-action/Chapter04# kubectl get cronjob
NAME                              SCHEDULE             SUSPEND   ACTIVE   LAST SCHEDULE   AGE
batch-job-every-fifteen-minutes   0,15,30,45 * * * *   False     0        <none>          28s
```

4.6.2 ìŠ¤ì¼€ì¤„ëœ Jobì˜ ì‹¤í–‰ ë°©ë²• ì´í•´

Job ë¦¬ì†ŒìŠ¤ëŠ” Crontab ë¦¬ì†ŒìŠ¤ì—ì„œ ì˜ˆì •ëœ ì‹œê°„ì— ìƒì„±ë˜ê³ , jobì€ podë¥¼ ìƒì„±í•œë‹¤.

Jobì´ë‚˜ Podê°€ìƒëŒ€ì ìœ¼ë¡œ ëŠ¦ê²Œ ìƒì„±/ì‹¤í–‰ë  ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ì‹œê°„ì„ ëª…í™•íˆ ì§€í‚¤ê²Œ í•˜ë ¤ë©´ ë³„ë„ì˜ ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.

startingDaedlineSeconds í•„ë“œë¥¼ ì§€ì •í•œë‹¤.

í•´ë‹¹ ì˜µì…˜ì€ ì˜ˆì •ëœ ì‹œê°„ì—ì„œ ëŠ¦ì–´ë„ 15ì´ˆ ì•ˆì—ëŠ” ì‹¤í–‰ ë˜ì–´ì•¼ í•˜ë©°, ì•ˆ ë  ê²½ìš° ì‹¤íŒ¨ë¡œ ë‚˜íƒ€ë‚¸ë‹¤.

```
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: batch-job-every-fifteen-minutes
spec:
  schedule: "* 30 * * *"
  startingDeadlineSeconds: 15
```
